{% extends "app/layout.html" %}

{% block content %}
<div class="row">
	<input type="date" id="dchange" onchange="changeDate(event);" />
</div>
<div class="row">
	<svg id="map" />
	<div id="table-wrapper" width="420px",height="610px">
		<div id="table-scroll">
			{% comment %}<p id="tit">Statewide Summaries</p>{% endcomment %}
			<table id="list">
				
				<caption id="tit">Statewide Summaries</caption>
				<tr id="tabhead">
				<thead>
				<th>State</th>
				<th>Total Cases</th>
				<th>Total Deaths</th>
				<th>Compare?</th>
				</thead>
				</tr>
				
			</table>
		</div>
	</div>
</div>
<div class="row" id="row2" style="margin-left:0; margin-right:0;">
	<svg id='bar' width="600" height="600" />
	<svg id='pie' width="300" height="350">
		<g transform="translate(150,150)"></g>
	</svg>
	<svg id='cpack' width="500" height="420">
		<g />
	</svg>
</div>


<script type="text/javascript">

	document.body.style.paddingLeft = '5px';
	document.body.style.paddingRight = '5px';
	var states = {{ usmap | safe }};
	var defColor = "#C3EAE3";
	var hColorMap = "ff6a00";
	var date = '2020-10-20';
	var detfac = 'cases';
    var cdata = {{ covidStates | safe }};
    var datedata = cdata[date];
    //console.log(d3.entries(datedata))
    //defColorTab = '#FFBEAC';
    var defColorTab = 'white';
    var colorTabSelect = '#FFBEAC';
	var hColorTab = "#3AD247";

	var scents = fillMap(states);
	var maxrad = 42;
	fillCircles(datedata,scents,detfac);
	fillTable(datedata);




    var Colors = {
		aqua: "#00ffff",
        darkred: "#8b0000",
        darkolivegreen: "#556b2f",
        orange: "#ffa500",
        blue: "#0000ff",
		brown: "#a52a2a",
        lime: "#00ff00",
        darkblue: "#00008b",
        darkcyan: "#008b8b",
        darkgrey: "#a9a9a9",
        darkgreen: "#006400",
        darkkhaki: "#bdb76b",
        darkmagenta: "#8b008b",
        darkorange: "#ff8c00",
        darkorchid: "#9932cc",
        darksalmon: "#e9967a",
        darkviolet: "#9400d3",
        fuchsia: "#ff00ff",
        gold: "#ffd700",
        green: "#008000",
        indigo: "#4b0082",
        lightblue: "#add8e6",
        lightgreen: "#90ee90",
        magenta: "#ff00ff",
        maroon: "#800000",
        navy: "#000080",
        olive: "#808000",
        pink: "#ffc0cb",
        purple: "#800080",
        yellow: "#ffff00"
    };
	var selected = {};


    
	var day1 = "2020-01-21";

	var ticks = 13;
	var txtht = 100;
	var activDates = drawBar();
	//console.log(activDates);

	
	var abv = {};
	for (i = 0; i < states.features.length; i++) {
		abv[states.features[i].properties.NAME10] = states.features[i].properties.STUSPS10;
	}
	abv.other = "other";
	abv.Guam = 'g';
	abv["Northern Mariana Islands"] = 'nmi';
	abv["Puerto Rico"] = 'PR';
	abv["Virgin Islands"] = 'vi';
	abv['Hawaii'] = 'HI';
    abv['Alaska'] = 'AK';
	console.log(abv);
	/*
    var abv = {};
    for (i = 0; i < states.features.length; i++) {
        abv[states.features[i].properties.NAME10.split(" ").join("")] = states.features[i].properties.STUSPS10;
    }
    console.log(abv);*/
	var invabv = objectFlip(abv);

	var nosp2sp = {};
	for (const st in datedata) {
		nosp2sp[String(st).split(" ").join("")] = st;
	}

	drawPie();
	drawPack();

	//console.log(nosp2sp);

	function changeDate(dat) {
		date = String(dat.target.value);
		console.log(date);
		datedata = cdata[date];
		updateCircles(datedata, scents, detfac);
		updateTable(datedata);
		activDates = drawBar();
		//console.log(activDates);
		//plotted = [...Object.keys(selected)];
		plotted = JSON.parse(JSON.stringify(selected));
        for (const [k, v] of Object.entries(plotted)) {
			remBar(k);
			addBar(k, v);
		}
		//drawPie();
		updatePie();
		drawPack();
		drawPack();

    }

	function objectFlip(obj) {
        return Object.entries(obj).reduce((ret, entry) => {
            const [key, value] = entry;
            ret[value] = key;
            return ret;
        }, {});
	}

	function fillMap(states) {


		var width = 900;
		var height = 600;
		var map = d3.select("#map");
		map.attr("height", height).attr("width", width);

		map.attr("ViewBox", "0 0 " + width + " " + height);
		//map.append("g").attr("fill", "none").attr("stroke-linejoin", 'round').attr("stroke-linecap", 'round');
		map.append("g").attr("stroke-linejoin", 'round').attr("stroke-linecap", 'round');
		map.style('padding-left', '2px');
		map.style('padding-right', '2px');
		map.style('padding-top', '2px');
		map.style('padding-bottom', '2px');
		map.style('left', '5px');




		//map.append("g").attr("fill", "none").attr("stroke","#000").attr("stroke-linejoin", 'round').attr("stroke-linecap", 'round');
		let path = d3.geoPath();
		/*let us = d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-albers-10m.json", function (json) {
			console.log(json);
		});
		*/

		/* TOPOJSON imp
		let us = {{ usmap|safe }}
 
		map.append("path").attr('stroke', '#000').attr('d',path(topojson.feature(us,us.objects.nation)))
		map.append("path").attr('d',path(topojson.feature(us,us.objects.nation)))
		*/


		//d3.json("usaMainland.json",drawUSA);


		//var width = 780;
		//var height=610;
		var proj = d3.geoEquirectangular().fitExtent([[0, 0], [width, height]], states);
		var geoGen = d3.geoPath().projection(proj);
		var paths = d3.select("#map")
			.selectAll('path')
			.data(states.features)
			.enter()
			.append('path')
			.attr('d', geoGen)
			.attr('stroke', '#fff')
			.attr('fill', defColor)
			.attr('id', function (d) {
				return String(d.properties.NAME10).split(" ").join("") + "M";
			})
			.on('mouseover', mouseOnMap)
			.on('mouseout', mouseOffMap)
			.on('click', onClickMap)
			;
			



		var scents = {};
		for (i = 0; i < states.features.length; i++) {
			
            scents[states.features[i].properties.NAME10] = Array.from(geoGen.centroid(states.features[i]));
            //console.log(geoGen.centroid(states.features[i])[0]);
		}
		//console.log(scents);
		return scents;
	}


    function fillCircles(datedata, scents,detfac = "cases") {

		//detfac = "cases";//determining factor

		//concat datedata
		let dlist = [];
        let maxst = "California";
        let mx = datedata[maxst][detfac];
		for (const [k, v] of Object.entries(datedata)) {
			//console.log(k);
			if (k in scents) {
				dlist.push({ 'key': k, 'value': v[detfac] });
			}
			if (v[detfac] > mx) {
				mx = v[detfac];
				maxst = k;
            }
        }


		//let dlist = d3.entries(datedata);

		/*find max OR assume cali is max
		let m = 0;
		for (i = 0; i < dlist.length; i++) {
			if (dlist[i].value[detfac] > m) {
				m = dlist[i].value[detfac];
            }
        }*/
		

		//console.log(dlist.length);
		var circs = d3.select("#map")
			.selectAll("circle")
			.data(dlist)
			.enter()
			.append("circle")
			.attr('fill-opacity', '0.4')
			.attr('fill', 'red')
			.attr('cx', function (d) {
				//console.log(scents[d.key]['0']);

				return scents[d.key]['0'];
			})
			.attr('cy', function (d) {
				return scents[d.key]['1'];
			})
			.attr('r', function (d) {
				return d.value / mx * maxrad;
			})
			.on('mouseover', function () {
				d3.select(this)
					.attr('fill', Colors['purple'])
					.attr('fill-opacity', '0.6');
			}).on('mouseout', function () {
				d3.select(this)
					.attr('fill', 'red')
					.attr('fill-opacity', '0.4');
			});
			
			
    }

	function updateCircles(datedata, scents, detfac = "cases") {
		let dlist = [];
        let maxst = "California";
        let mx = datedata[maxst][detfac];
        for (const [k, v] of Object.entries(datedata)) {
            //console.log(k);
            if (k in scents) {
                dlist.push({ 'key': k, 'value': v[detfac] });
            }
            if (v[detfac] > mx) {
                mx = v[detfac];
                maxst = k;
            }
        }


        //let dlist = d3.entries(datedata);

		/*find max OR assume cali is max
		let m = 0;
		for (i = 0; i < dlist.length; i++) {
			if (dlist[i].value[detfac] > m) {
				m = dlist[i].value[detfac];
            }
        }*/


        //console.log(dlist.length);
        var circs = d3.select("#map")
            .selectAll("circle")
			.data(dlist)
            .attr('r', function (d) {
                return d.value / mx * maxrad;
            });
    }

	function fillTable(datedata) { //datedata = dat[date]
		let dlist = d3.entries(datedata);
		/*
        var tab = d3.select("#table-wrapper").select('#table-scroll').select('#list');
	
		rows = tab.selectAll("tr").filter(function () {
			return !this.classList.contains("tabhead");
		})
			.data(dlist)
			.enter()//;
			.append("tr")
			.attr('id', function (d) {
				return d.key;
			})
			.on('mouseover', mouseOnMap);
	
        rows.selectAll("td").data(function (d) {
            
            console.log([d.key, d.value['cases'], d.value['deaths']])
            return [d.key, d.value['cases'], d.value['deaths']];
        })
            .enter()
            .append("td").text(function (d) {
                //console.log(d + "1")
                return d;
			})
			;
			*/
        d3.select("#tit").text("Statewide Summaries for " + date).style('background-color', 'white').style('font-family', "Arial, Helvetica, sans - serif").style('font-weight', 900).style('font-size', '36px');
        var tab = d3.select("#table-wrapper").select('#table-scroll').select('#list');

        rows = tab.selectAll(".statetab")
            .data(dlist)
            .enter()
            .append("tr")
            .attr('id', function (d) {
                return d.key.split(" ").join("");
            })
            .attr('class', 'statetab')
            .on('mouseover', mouseOnTab)
            .on('mouseout', mouseOffTab)
            .on('click', onClickTab);
		/*
		rows = tab.selectAll("tr").filter(function () {
            //console.log(!this.id == 'tabhead');
			console.log(this.id=='tabhead');
			return !this.id == 'tabhead';
        })
            .data(dlist)
            .enter()
            .append("tr")
            .attr('id', function (d) {
                return d.key;
			})
			.attr('class','statetab')
            .on('mouseover', mouseOnTab)
			.on('mouseout', mouseOffTab)
			.on('click',onClickTab);
		*/
		/*
		rows = tab.selectAll("tr").filter(function () {
			//console.log(!this.id == 'tabhead');
			console.log(this.id == 'tabhead');
			return !(this.id == 'tabhead');
		});
        rows = rows.data(dlist)
            .enter()
            .append("tr")
            .attr('id', function (d) {
                return d.key;
            })
            .on('mouseover', mouseOnTab)
            .on('mouseout', mouseOffTab);
			*/
        rows.selectAll("td").data(function (d) {

            //console.log([d.key, d.value['cases'], d.value['deaths']])
            return [d.key, d.value['cases'], d.value['deaths']];
        })
            .enter()
            .append("td").text(function (d) {
                //console.log(d + "1")
                return d;
			})
			.attr('class','dat')
            ;
			/*
        var tab = d3.select("#table-wrapper").select('#table-scroll').select('#list').select("#tabBody");
		rows = tab.selectAll("tr")
			.data(dlist)
			.enter()
			.append("tr")
            .attr('id', function (d) {
                return d.key;
            })
            .on('mouseover', mouseOnMap);
	*/
        /*tab.selectAll("tr").filter(function () {
            return !this.classList.contains("tabhead")
        })
			.append("td").attr('class','ckbx').append("input").attr("type", 'checkbox');
			*/
		rows.append("td").attr('id', function (d) {
			return d.key + "chk";
		})
			.attr('class', 'chk');	;//.append("input").attr("type", 'checkbox');
    /*
	*/
    }

	function updateTable(datedata) {
		//let dlist = d3.entries(datedata);
        d3.select("#tit").text("Statewide Summaries for " + date).style('background-color', 'white').style('font-family', "Arial, Helvetica, sans - serif").style('font-weight', 900).style('font-size', '36px');
        var tab = d3.select("#table-wrapper").select('#table-scroll').select('#list');

		for (const [k, v] of Object.entries(datedata)) {
			tab.select("#" + k)
				.selectAll(".dat")
				.data([k, v.cases, v.deaths])
				.text(function (d) {
					return d;
				});
		}

    }


	function mouseOnMap() {
		d3.select(this).style('fill', hColorMap);
		//console.log("#" + this.id.substr(0, this.id.length - 2))
        d3.select("#table-wrapper").select('#table-scroll').select('#list').select("#" + this.id.substr(0, this.id.length - 1)).selectAll(".dat").style('background-color', hColorTab);
	//Highlight on list
	}

	function mouseOffMap(){
		d3.select(this).style('fill', defColor);
        d3.select("#table-wrapper").select('#table-scroll').select('#list').select("#" + this.id.substr(0, this.id.length - 1)).selectAll(".dat").style('background-color', defColorTab);

	}

	function mouseOnTab() {
		//console.log(this.id);
		var nam = String(this.id);
        d3.select("#map").select("#" + nam +"M").style('fill', hColorMap);
		//d3.select(this).selectAll(".dat").style('fill', hColorTab);
		
		d3.select("#table-wrapper").select('#table-scroll').select('#list').select("#" + nam)
			.selectAll(".dat")
            .style('background-color', hColorTab);

			
        //Highlight on list
    }

	function mouseOffTab() {
		var nam = String(this.id);
        d3.select("#table-wrapper").select('#table-scroll').select('#list').select("#" + nam)
            .selectAll(".dat")
            .style('background-color', defColorTab);
		//d3.select("#table-wrapper").select('#table-scroll').select('#list').select("#" + nam).selectAll("td").style('background-color', defColorTab);
        d3.select("#map").select("#" + this.id + "M").style('fill', defColor);

    }
	
	function onClickMap() {
		var state = this.id.substr(0, this.id.length - 1);
		//check state in chart, if !present -> addBar() else remove
		var chkbx = d3.select("#table-wrapper").select('#table-scroll').select('#list').select("#" + state).select(".chk");
		//console.log(chkbx);
		console.log(chkbx.classed('chk'));
		if (chkbx.classed("selected")) {
			remBar(state);
            updatePie();
			chkbx.classed("selected", false);
            chkbx.style('background-color', 'white');
		} else {
            if (Object.keys(selected).length < Object.keys(Colors).length) {
                newcolor = randColor();
				addBar(state, newcolor);
                updatePie();
                chkbx.classed("selected", true);
                //determine color then addBar
                chkbx.style('background-color', newcolor);
            }
        }
	}

	function onClickTab() {
		var state = String(this.id).split(" ").join("");
        var chkbx = d3.select("#table-wrapper").select('#table-scroll').select('#list').select("#" + state).select(".chk");
        console.log(state);
       // console.log(chkbx.classed('chk'));
        if (chkbx.classed("selected")) {
			remBar(state);
			updatePie();
            chkbx.classed("selected", false);
            chkbx.style('background-color', 'white');
		} else {
			if (Object.keys(selected).length < Object.keys(Colors).length) {
				newcolor = randColor();
				addBar(state, newcolor);
				updatePie();
				chkbx.classed("selected", true);
				//determine color then addBar
				chkbx.style('background-color', newcolor);
				}
        }
	}

	function randColor() {
		if (Object.values(selected).length > 0) {
			let used = Object.values(selected);
			let unused = [];
			for (k in Colors) {
				if (!used.includes(Colors[k])) unused.push(Colors[k]);
			}
			console.log(unused[Math.floor(Math.random() * Math.floor(unused.length))]);
			return unused[Math.floor(Math.random() * Math.floor(unused.length))];
		}
		else {
            return Object.values(Colors)[Math.floor(Math.random() * Math.floor(Object.values(Colors).length))];
        }
    }
	/*
    function onClick(source) {
		var state = String(this.id);
		if (source == 'map') {
			state = state.substr(0, state.length - 1);
        }
        var chkbx = d3.select("#table-wrapper").select('#table-scroll').select('#list').select("#" + state).select(".chk");
        console.log(chkbx);
        console.log(chkbx.classed('chk'));
        if (chkbx.classed("selected")) {
            remBar(state);
            chkbx.classed("selected", false);
            chkbx.style('background-color', 'white');
        } else {
            addBar(state);
            chkbx.classed("selected", true);
            //determine color then addBar
            chkbx.style('background-color', 'red');
        }
    }
*/
	function drawBar() {
		var fontSz = 18;
		//var pad = 0;

		var bar = d3.select("#bar");
		bar.style("padding-left", "10px");
        bar.style('padding-right', '2px');
        bar.style('padding-top', '2px');
		bar.style('padding-bottom', '0px');
		
		var tw = parseFloat(bar.attr("width"));
		var th = parseFloat(bar.attr("height"));
		//var txtht = 100;
		//console.log(bwid + 1);
		let d1 = new Date(day1);
		let df = new Date(date);
		//let difdays = Math.ceil(Math.abs(df - d1)(1000 * 60 * 60 * 24));
		let sf = 13; //shift factor
		var bw = (th-2*sf) / ticks;

		//preprocess
		let dlist = [];
		for (const [d, v] of Object.entries(cdata)) {
			let dat = new Date(d);
			if (dat - d1 >= 0 && df - dat >= -1) {
				dlist.push(d);
            }
		}
		dlist.sort(function (a, b) {
			adat = new Date(a);
			bdat = new Date(b);
			return a < b ? 1 : -1;
		})
		//dsub = everyN(dlist.reverse(), Math.round(dlist.length/ticks)).reverse(); //double reverse prioritizes last date on ticks
        dsub = everyN(dlist, Math.round(dlist.length / ticks)).reverse();
		bar.selectAll("text").remove();
		bar.selectAll("text")
			.data(dsub)
			.enter()
			.append("text")
			.attr('x', "0")
			.attr('y', function (d, i) {
				return (i) * bw+sf;
			})
			.attr('font-size', fontSz)
			.text(function (d) {
				return d;
			})
			.attr("id",function (d, i) {
				return "bar" + i;
			});
		bar.attr("transform", "rotate(270)");
		//console.log(dlist.length);
		return dlist.slice(dlist.indexOf(dsub[dsub.length-1]), dlist.length).reverse();
	}

	function everyN(arr, n) {
		return arr.filter((e, i) => i % n == 0);
    }

	function addBar(state, color) {
		//var txtht = 100;
		var sf = 13;
		// find all bars and scale
		var bar = d3.select("#bar");
        var bw = parseFloat(bar.attr("width"));
        var bh = parseFloat(bar.attr("height"));

		let dlist = [];
		let mx = 0;
		selected[state] = color;
		for (i = 0; i < activDates.length; i++) {
            var datedat = cdata[String(activDates[i])];
			//console.log(datedat[state]);
			//console.log(activDates[i]);
			try {
				dlist.push(datedat[nosp2sp[state]][detfac]);
			}
			catch{
				//console.log(state);
				//console.log(String(activDates[i]));
				dlist.push(0);
            }
		}
		/*
		for (const d in activDates) {
			let datedat = cdata[String(d)];
			console.log(d);
			dlist.push(datedat[state][detfac]);
		}
		*/
		for (const st in selected) {
            let v = cdata[activDates[activDates.length - 1]][nosp2sp[st]][detfac];
            if (v > mx) mx = v;
        }
		//console.log(dlist);

        if (mx == cdata[activDates[activDates.length - 1]][nosp2sp[state]][detfac] && Object.keys(selected).length > 1) {//rescale
			
			for (st in selected) {
				let dlist = [];
                for (i = 0; i < activDates.length; i++) {
                    var datedat = cdata[String(activDates[i])];
                    //console.log(datedat[state]);
                    //console.log(activDates[i]);
                    try {
                        dlist.push(datedat[nosp2sp[st]][detfac]);
                    }
                    catch{
                        //console.log(state);
                        //console.log(String(activDates[i]));
                        dlist.push(0);
                    }
                }
				bar.selectAll("." + st + "bar")
					.data(dlist)
					.attr("width", function (d, i) {
						return d / mx * (bw - txtht);
					});
            }
		}
		barht = bh / dlist.length;
		var strects = bar.selectAll("." + state + "bar")
			.data(dlist)
			.enter()
			.append("rect")
			.attr("x", txtht)
			.attr("y", function (d, i) {
				return (i) * barht - sf;
			})
			.attr("width", function (d, i) {
				return d / mx * (bw - txtht);
			})
			.attr("height", barht)
			.style("fill", color)
			.classed(state + "bar", true);

		
		
		bar.selectAll("rect")
            .style("fill-opacity", Object.keys(selected).length>4? .25: 1 / Object.keys(selected).length);
	}

	function remBar(state) {

		var bar = d3.select("#bar");

		var bh = parseFloat(bar.attr("height"));
        var bw = parseFloat(bar.attr("height"));
        //var barht = bh / activDates.length;

		bar.selectAll("." + state + "bar").remove();

		let mx = 0;
        for (const st in selected) {
            let v = cdata[activDates[activDates.length - 1]][nosp2sp[st]][detfac];
            if (v > mx) mx = v;
        }
		delete selected[state];

		if (mx == cdata[activDates[activDates.length - 1]][nosp2sp[state]][detfac] && Object.keys(selected).length > 0) {//rescale
			mx = 0;
			for (const st in selected) {
                let v = cdata[activDates[activDates.length - 1]][nosp2sp[st]][detfac];
                if (v > mx) mx = v;
			}
            for (const st in selected) {
                let dlist = [];
                for (i = 0; i < activDates.length; i++) {
                    var datedat = cdata[String(activDates[i])];
                    //console.log(datedat[state]);
                    //console.log(activDates[i]);
                    try {
                        dlist.push(datedat[nosp2sp[st]][detfac]);
                    }
                    catch{
                        //console.log(state);
                        //console.log(String(activDates[i]));
                        dlist.push(0);
                    }
                }
                bar.selectAll("." + st + "bar")
                    .data(dlist)
                    .attr("width", function (d, i) {
                        return d / mx * (bw - txtht);
                    });
            }

		}
		


        bar.selectAll("rect")
            .style("fill-opacity", Object.keys(selected).length > 4 ? .25 : 1 / Object.keys(selected).length);

	}

	function drawPie() {
		let dlist = d3.entries(datedata);
		dlist.sort((a, b) => (a.value[detfac] > b.value[detfac] ? -1 : 1));
		//console.log(dlist);
		var top5 = {};
		for (i = 0; i < 4; i++) {
			top5[dlist[i].key] = dlist[i].value[detfac];
		}
		//console.log(dlist.slice(4))
		s = 0;
		for (i = 4; i < dlist.length; i++) {
			s += dlist[i].value[detfac];
        }
		top5['other'] = s;
		//console.log(top5);

		tot = Object.values(top5).reduce((a, b) => a + b, 0);
		//console.log(tot);
		var top5frac = {};
		var ents = Object.entries(top5);
		for (i = 0; i < ents.length; i++) {
			//console.log(ents[i]);
            top5frac[ents[i][0]] = ents[i][1] / tot * 2 * Math.PI;
        }
		/*
		for (const [k, v] in Object.entries(top5)) {
			console.log(v);
			top5frac[v[0]] = v[1] / tot * 2 * Math.PI;
		}
		*/
		//console.log(top5frac);
		ang = 0;
        var ents = Object.entries(top5frac);
		var arcdata = [];
        for (i = 0; i < ents.length; i++) {
			//console.log(k);
            arcdata.push({ label: abv[ents[i][0]], startAngle: ang, endAngle: ang + ents[i][1] });
            ang += ents[i][1];

		}

		//console.log(arcdata);
		var arcGen = d3.arc()
			.innerRadius(20)
			.outerRadius(150);

		d3.select("#row2").select("#pie")
			.select('g')
			.selectAll('path').remove();

		d3.select("#row2").select("#pie").select('g')
			.selectAll('text').remove();

        d3.select("#row2").select("#pie")
			.selectAll('g')
			.selectAll('path')
			.data(arcdata)
			.enter()
			.append('path')
			.attr('d', arcGen)
			.style("fill", "orange")
			.style("fill-opacity",0.85)
			.style("stroke","white");

		d3.select("#row2").select("#pie").selectAll('g')
			.selectAll('text')
			.data(arcdata)
			.enter()
			.append('text')
			.each(function (d) {
				console.log(d);
				var centroid = arcGen.centroid(d);
				d3.select(this)
					.attr('x', centroid[0])
					.attr('y', centroid[1])
					.attr('dy', '0.33em')
					.text(d.label)// + "\n" + ((d.endAngle - d.startAngle) / 2 / Math.PI).toFixed(1) + "%")
					//.text(((d.endAngle - d.startAngle) / 2 / Math.PI).toFixed(1) + "%")
					.attr('id', invabv[d.label].split(" ").join("")+"pie")
					.attr('class', function () {
						if (d.label == "other") {
							return "otherPie";
						} else { return "stPie";}
                    })
					;
			});
        d3.select("#row2").select("#pie").selectAll('g')
            .selectAll('.percs')
            .data(arcdata)
            .enter().append("text")
            .each(function (d) {
                console.log(d);
                var centroid = arcGen.centroid(d);
                d3.select(this)
                    .attr('x', centroid[0]+1)
                    .attr('y', centroid[1]+14)
					.attr('dy', '0.33em')
				
                    //.text(d.label)// + "\n" + ((d.endAngle - d.startAngle) / 2 / Math.PI).toFixed(1) + "%")
					.text(((d.endAngle - d.startAngle) *100/ 2 / Math.PI).toFixed(1) + "%")
					.style("font-size",10)
					.attr('class', 'percs');
				//console.log(((d.endAngle - d.startAngle) / 2 / Math.PI));
			});
    }

	function updatePie() {
		let astates = Object.keys(selected);
		console.log(astates);
		if (astates.length == 0) {
			drawPie();
		} else {
			let dlist = d3.entries(datedata);
			//let val = cdata[date][state][detfac];

			let othsum = 0;
			let total = 0;
			for (i = 0; i < dlist.length; i++) {
				if (!(dlist[i].key.split(" ").join("") in selected)) {
					othsum += dlist[i].value[detfac];
				}
				total += dlist[i].value[detfac];
			}

			var arcdata = [];
			let ang = 0;
			for (i = 0; i < astates.length; i++) {
				//console.log(k);
				arcdata.push({ label: abv[nosp2sp[astates[i]]], startAngle: ang, endAngle: ang + datedata[nosp2sp[astates[i]]][detfac] / total * 2 * Math.PI });
				ang += datedata[nosp2sp[astates[i]]][detfac] / total * 2 * Math.PI;

			}
			arcdata.push({ label: "other", startAngle: ang, endAngle: 2 * Math.PI })
			console.log(arcdata);



			var arcGen = d3.arc()
				.innerRadius(20)
				.outerRadius(150);

			d3.select("#row2").select("#pie")
				.select('g')
				.selectAll('path').remove();

			d3.select("#row2").select("#pie").selectAll('g')
				.selectAll('text').remove();

			d3.select("#row2").select("#pie")
				.selectAll('g')
				.selectAll('path')
				.data(arcdata)
				.enter()
				.append('path')
				.attr('d', arcGen)
				.style("fill", function (d) {
					if (d.label == 'other') {
						return "orange";
					} else {
						console.log(invabv[d.label]);
						return selected[invabv[d.label].split(" ").join("")];
					}
				})
				.style("fill-opacity", 0.85)
				.style("stroke", "white")
				.attr("id", function (d) {
					if (d.label != 'other') {
						console.log(d.label);
						return invabv[d.label].split(" ").join("") + "path";
					}
					return "otherpath";
			})

            d3.select("#row2").select("#pie").selectAll('g')
                .selectAll('text')
                .data(arcdata)
                .enter()
                .append('text')
                .each(function (d) {
                    console.log(d);
                    var centroid = arcGen.centroid(d);
                    d3.select(this)
                        .attr('x', centroid[0])
                        .attr('y', centroid[1])
                        .attr('dy', '0.33em')
                        .text(d.label)// + "\n" + ((d.endAngle - d.startAngle) / 2 / Math.PI).toFixed(1) + "%")
                        //.text(((d.endAngle - d.startAngle) / 2 / Math.PI).toFixed(1) + "%")
                        .attr('id', invabv[d.label].split(" ").join("") + "pie")
                        .attr('class', function () {
                            if (d.label == "other") {
                                return "otherPie";
                            } else { return "stPie"; }
                        })
                        ;
                });
            d3.select("#row2").select("#pie").selectAll('g')
                .selectAll('.percs')
                .data(arcdata)
                .enter().append("text")
                .each(function (d) {
                    console.log(d);
                    var centroid = arcGen.centroid(d);
                    d3.select(this)
                        .attr('x', centroid[0] + 1)
                        .attr('y', centroid[1] + 14)
                        .attr('dy', '0.33em')

                        //.text(d.label)// + "\n" + ((d.endAngle - d.startAngle) / 2 / Math.PI).toFixed(1) + "%")
                        .text(((d.endAngle - d.startAngle) * 100 / 2 / Math.PI).toFixed(1) + "%")
                        .style("font-size", 10)
                        .attr('class', 'percs');
                    //console.log(((d.endAngle - d.startAngle) / 2 / Math.PI));
                });

		}

		
	}

	function drawPack() {
		var pack = d3.select("#cpack");
		var wd = parseFloat(pack.attr("width"));
		var ht = parseFloat(pack.attr("height"));


		var dat = { "name": "US", "children": [] };
		let flat = Object.entries(datedata);
		console.log(flat);
		console.log(flat.length);
		for (i = 0; i < flat.length; i++) {


			dat['children'].push({ 'name': abv[flat[i][0]], "value": flat[i][1][detfac] });
		}
		//console.log(dat);
		var root = d3.hierarchy(dat);
		root.sum((d) => d.value);
		var packLayout = d3.pack()
			.size([wd, ht])
			.padding(5);

		packLayout(root);
		var allUS = root.descendants();
		console.log(allUS);
		var nodes = pack.selectAll('g');
		nodes.remove();
		nodes=nodes.data(allUS)
			.enter()
			.append('g')
			.attr('transform', function (d) {
				return "translate(" + [d.x, d.y] + ")";
			});

			nodes.append('circle')
			.attr('r', function (d) {
				return d.r;
			}).style("fill", "indianred")
			.attr('id',(d)=>invabv[d.data.name].split(" ").join("")+'pack');

		/*pack.selectAll('g')
			.data(allUS)
			.enter()
			.append('text')*/
		nodes.append("text")
			.attr('dy', function (d) {
				return 3 ;
			})
			.attr('dx',-6.3)
			.text(function (d) {
				return d.data.name;
			}).style("font-size",11);
    }

</script>

{% endblock %}